generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Invoice {
  id                    Int                @id @default(autoincrement())
  createdAt             DateTime           @default(now())
  updatedAt             DateTime
  invoiceDate           DateTime
  invoiceNumber         String             @unique
  issuerName            String
  receiverName          String
  totalSales            Decimal
  totalDiscount         Decimal
  netAmount             Decimal
  total                 Decimal
  invoiceStatus         String
  currency              String             @default("EGP")
  exchangeRate          Decimal
  taxAmount             Decimal
  issuerCountry         String
  receiverCountry       String
  issuerEtaId           String
  receiverEtaId         String
  customerId            Int?
  supplierId            Int?
  exactMatchingRequired Boolean            @default(false)
  matchingKeywords      String[]
  Customer              Customer?          @relation(fields: [customerId], references: [id])
  Supplier              Supplier?          @relation(fields: [supplierId], references: [id])
  TransactionMatch      TransactionMatch[]
}

model Customer {
  id            Int             @id @default(autoincrement())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  name          String
  country       String?
  etaId         String?
  paymentTerms  Int?
  BankStatement BankStatement[]
  Invoice       Invoice[]
}

model Supplier {
  id            Int             @id @default(autoincrement())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  name          String
  country       String?
  etaId         String?
  paymentTerms  Int?
  BankStatement BankStatement[]
  Invoice       Invoice[]
}

model Bank {
  id             Int             @id @default(autoincrement())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  name           String          @unique
  bankStatements BankStatement[]
}

model BankStatement {
  id                   Int               @id @default(autoincrement())
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  fileName             String?
  bankName             String
  accountNumber        String
  statementPeriodStart DateTime
  statementPeriodEnd   DateTime
  accountType          String?
  accountCurrency      String?
  startingBalance      Decimal
  endingBalance        Decimal
  rawTextContent       String?
  processingStatus     String            @default("processed")
  customerId           Int?
  supplierId           Int?
  bankId               Int
  fileUrl              String?
  locked               Boolean           @default(false)
  parsed               Boolean           @default(false)
  validated            Boolean           @default(false)
  validatedAt          DateTime?
  validatedBy          String?
  validationNotes      String?
  validationStatus     String            @default("pending")
  googleSheetId        String?
  bank                 Bank              @relation(fields: [bankId], references: [id])
  Customer             Customer?         @relation(fields: [customerId], references: [id])
  Supplier             Supplier?         @relation(fields: [supplierId], references: [id])
  MatchingSession      MatchingSession[]
  transactions         Transaction[]
}

model Transaction {
  id                        Int                        @id @default(autoincrement())
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  transactionDate           DateTime
  creditAmount              Decimal?
  debitAmount               Decimal?
  description               String?
  balance                   Decimal?
  pageNumber                String?
  entityName                String?
  bankStatementId           Int
  classificationNotes       String?
  currency                  String?
  extractedEntities         String[]
  extractedReferences       String[]
  requiresManualReview      Boolean                    @default(false)
  classificationId          Int?
  alternativeCategories     String[]                   @default([])
  category                  TransactionCategory?
  classificationMethod      String?
  classificationReason      String?
  classifiedAt              DateTime?
  confidence                Float?
  isEligible                Boolean?
  llmModel                  String?
  llmPromptVersion          String?
  manualClassification      TransactionCategory?
  manualNotes               String?
  manuallyClassifiedAt      DateTime?
  manuallyClassifiedBy      String?
  manuallyOverridden        Boolean                    @default(false)
  processingTime            Int?
  bankStatement             BankStatement              @relation(fields: [bankStatementId], references: [id], onDelete: Cascade)
  TransactionClassification TransactionClassification? @relation(fields: [classificationId], references: [id])
  TransactionMatch          TransactionMatch[]
}

model MatchingSession {
  id                   Int           @id @default(autoincrement())
  createdAt            DateTime      @default(now())
  updatedAt            DateTime
  bankStatementId      Int
  startedBy            String
  completedAt          DateTime?
  totalTransactions    Int
  eligibleTransactions Int
  unknownTransactions  Int
  automaticMatches     Int
  suggestedMatches     Int
  potentialMatches     Int
  manualMatches        Int
  passedStrictCriteria Int
  status               SessionStatus @default(IN_PROGRESS)
  BankStatement        BankStatement @relation(fields: [bankStatementId], references: [id])
}

model TransactionClassification {
  id                    Int                  @id @default(autoincrement())
  createdAt             DateTime             @default(now())
  updatedAt             DateTime
  category              TransactionCategory
  isEligible            Boolean
  confidence            Float
  reason                String
  extractedEntities     String[]
  extractedReferences   String[]
  currency              String?
  classificationMethod  String               @default("LLM")
  alternativeCategories String[]
  requiresManualReview  Boolean              @default(false)
  manuallyOverridden    Boolean              @default(false)
  manualClassification  TransactionCategory?
  manualNotes           String?
  manuallyClassifiedAt  DateTime?
  manuallyClassifiedBy  String?
  llmModel              String?
  llmPromptVersion      String?
  processingTime        Int?
  Transaction           Transaction[]
}

model TransactionMatch {
  id                       Int                 @id @default(autoincrement())
  createdAt                DateTime            @default(now())
  updatedAt                DateTime
  transactionId            Int
  invoiceId                Int?
  matchType                MatchType
  matchScore               Float
  matchReason              String[]
  passedStrictCriteria     Boolean
  strictCriteriaDetails    Json?
  status                   MatchStatus         @default(PENDING)
  verifiedAt               DateTime?
  verifiedBy               String?
  verificationNotes        String?
  isEligible               Boolean
  transactionCategory      TransactionCategory
  classificationReason     String?
  classificationConfidence Float?
  Invoice                  Invoice?            @relation(fields: [invoiceId], references: [id])
  Transaction              Transaction         @relation(fields: [transactionId], references: [id])

  @@unique([transactionId, invoiceId])
}

enum MatchStatus {
  PENDING
  APPROVED
  REJECTED
  DISPUTED
  REQUIRES_REVIEW
}

enum MatchType {
  AUTOMATIC
  SUGGESTED
  POTENTIAL
  MANUAL
}

enum SessionStatus {
  IN_PROGRESS
  PENDING_REVIEW
  COMPLETED
  CANCELLED
}

enum TransactionCategory {
  CUSTOMER_PAYMENT
  SUPPLIER_PAYMENT
  INTERNAL_TRANSFER
  BANK_CHARGES
  BANK_PAYMENTS
  UNKNOWN
  OTHER
}
