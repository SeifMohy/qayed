generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Invoice {
  id                    Int                @id @default(autoincrement())
  createdAt             DateTime           @default(now())
  updatedAt             DateTime
  invoiceDate           DateTime
  invoiceNumber         String             @unique
  issuerName            String
  receiverName          String
  totalSales            Decimal
  totalDiscount         Decimal
  netAmount             Decimal
  total                 Decimal
  invoiceStatus         String
  currency              String             @default("EGP")
  exchangeRate          Decimal
  taxAmount             Decimal
  issuerCountry         String
  receiverCountry       String
  issuerEtaId           String
  receiverEtaId         String
  customerId            Int?
  supplierId            Int?
  exactMatchingRequired Boolean            @default(false)
  matchingKeywords      String[]
  expectedPaymentDates  Json?              // Phase 1: Expected payment dates based on payment terms
  Customer              Customer?          @relation(fields: [customerId], references: [id])
  Supplier              Supplier?          @relation(fields: [supplierId], references: [id])
  TransactionMatch      TransactionMatch[]
  CashflowProjection    CashflowProjection[] // Phase 1: Link to cashflow projections
}

model Customer {
  id               Int             @id @default(autoincrement())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  name             String
  country          String?
  etaId            String?
  paymentTermsData Json?           // New comprehensive payment terms
  Invoice          Invoice[]
}

model Supplier {
  id               Int             @id @default(autoincrement())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  name             String
  country          String?
  etaId            String?
  paymentTermsData Json?           // New comprehensive payment terms
  Invoice          Invoice[]
}

model Bank {
  id             Int             @id @default(autoincrement())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  name           String          @unique
  bankStatements BankStatement[]
}

model BankStatement {
  id                   Int               @id @default(autoincrement())
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  fileName             String?
  bankName             String
  accountNumber        String
  statementPeriodStart DateTime
  statementPeriodEnd   DateTime
  accountType          String?
  accountCurrency      String?
  startingBalance      Decimal
  endingBalance        Decimal
  rawTextContent       String?
  processingStatus     String            @default("processed")
  bankId               Int
  fileUrl              String?
  locked               Boolean           @default(false)
  parsed               Boolean           @default(false)
  validated            Boolean           @default(false)
  validatedAt          DateTime?
  validatedBy          String?
  validationNotes      String?
  validationStatus     String            @default("pending")
  googleSheetId        String?
  bank                 Bank              @relation(fields: [bankId], references: [id])
  transactions         Transaction[]
}

model Transaction {
  id                        Int                        @id @default(autoincrement())
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  transactionDate           DateTime
  creditAmount              Decimal?
  debitAmount               Decimal?
  description               String?
  balance                   Decimal?
  pageNumber                String?
  entityName                String?
  bankStatementId           Int
  classificationNotes       String?
  currency                  String?
  extractedEntities         String[]
  extractedReferences       String[]
  requiresManualReview      Boolean                    @default(false)
  classificationId          Int?
  alternativeCategories     String[]                   @default([])
  category                  TransactionCategory?
  classificationMethod      String?
  classificationReason      String?
  classifiedAt              DateTime?
  confidence                Float?
  isEligible                Boolean?
  llmModel                  String?
  llmPromptVersion          String?
  manualClassification      TransactionCategory?
  manualNotes               String?
  manuallyClassifiedAt      DateTime?
  manuallyClassifiedBy      String?
  manuallyOverridden        Boolean                    @default(false)
  processingTime            Int?
  bankStatement             BankStatement              @relation(fields: [bankStatementId], references: [id], onDelete: Cascade)
  TransactionMatch          TransactionMatch[]
}

model TransactionMatch {
  id                       Int                 @id @default(autoincrement())
  createdAt                DateTime            @default(now())
  updatedAt                DateTime
  transactionId            Int
  invoiceId                Int?
  matchType                MatchType
  matchScore               Float
  matchReason              String[]
  passedStrictCriteria     Boolean
  strictCriteriaDetails    Json?
  status                   MatchStatus         @default(PENDING)
  verifiedAt               DateTime?
  verifiedBy               String?
  verificationNotes        String?
  isEligible               Boolean
  transactionCategory      TransactionCategory
  classificationReason     String?
  classificationConfidence Float?
  Invoice                  Invoice?            @relation(fields: [invoiceId], references: [id])
  Transaction              Transaction         @relation(fields: [transactionId], references: [id])

  @@unique([transactionId, invoiceId])
}

// Phase 1: Cashflow Projection System
model CashflowProjection {
  id              Int           @id @default(autoincrement())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  projectionDate  DateTime      // Date this projection is for
  projectedAmount Decimal       // Positive for inflows, negative for outflows
  actualAmount    Decimal?      // Actual amount when it occurs
  type            CashflowType
  status          CashflowStatus @default(PROJECTED)
  confidence      Float         @default(1.0) // 0.0 to 1.0
  description     String?
  
  // Phase 1: Only invoice relationships
  invoiceId       Int?
  Invoice         Invoice?      @relation(fields: [invoiceId], references: [id])
  
  @@index([projectionDate])
  @@index([type, status])
  @@index([invoiceId])
}

// Phase 1: Enums
enum CashflowType {
  CUSTOMER_RECEIVABLE
  SUPPLIER_PAYABLE
  // Phase 3: Additional types will be added later
  // BANK_OBLIGATION
  // INTERNAL_TRANSFER
  // TAX_PAYMENT
  // LOAN_PAYMENT
  // OTHER_INCOME
  // OTHER_EXPENSE
}

enum CashflowStatus {
  PROJECTED
  CONFIRMED
  PARTIAL
  COMPLETED
  OVERDUE
  CANCELLED
}

enum MatchStatus {
  PENDING
  APPROVED
  REJECTED
  DISPUTED
  REQUIRES_REVIEW
}

enum MatchType {
  AUTOMATIC
  SUGGESTED
  POTENTIAL
  MANUAL
}


enum TransactionCategory {
  CUSTOMER_PAYMENT
  SUPPLIER_PAYMENT
  INTERNAL_TRANSFER
  BANK_CHARGES
  BANK_PAYMENTS
  UNKNOWN
  OTHER
}
